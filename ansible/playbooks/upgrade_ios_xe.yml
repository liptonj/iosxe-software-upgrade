---
- name: Cisco IOS-XE 9300 Upgrade Playbook
  hosts: switches
  gather_facts: false
  serial: "{{ serial_mode | default('100%') }}" # Override: -e "serial_mode=1" for one at a time
  max_fail_percentage: "{{ max_fail_pct | default(100) }}" # Override: -e "max_fail_pct=0" to abort on any failure
  any_errors_fatal: "{{ fail_fast | default(false) | bool }}" # Override: -e "fail_fast=true"

  vars:
    # Default target version - can be overridden per model or per host
    target_version: "17.15.04"
    # Default image file - can be overridden per model or per host
    image_file: "cat9k_iosxe.17.15.04.SPA.bin"

    # Model-specific version mapping (optional)
    target_versions_by_model:
      C9200: "17.15.04"
      C9200CX: "17.15.04"
      C9200L: "17.15.04"
      C9300: "17.15.04"
      C9300X: "17.15.04"
      C9350: "17.15.04"
      C9400: "17.15.04"
      C9500: "17.15.04"
      C9500X: "17.15.04"

    # Model-specific image mapping (optional)
    image_files_by_model:
      C9200: "cat9k_iosxe.17.15.04.SPA.bin"
      C9200CX: "cat9k_iosxe.17.15.04.SPA.bin"
      C9200L: "cat9k_iosxe.17.15.04.SPA.bin"
      C9300: "cat9k_iosxe.17.15.04.SPA.bin"
      C9300X: "cat9k_iosxe.17.15.04.SPA.bin"
      C9350: "cat9k_iosxe.17.15.04.SPA.bin"
      C9400: "cat9k_iosxe.17.15.04.SPA.bin"
      C9500: "cat9k_iosxe.17.15.04.SPA.bin"
      C9500X: "cat9k_iosxe.17.15.04.SPA.bin"

    # Upgrade settings
    required_space_mb: 2048
    install_timeout: 1200
    reboot_wait_timeout: 300

    # Backup settings
    backup_enabled: true
    backup_dir_name: "backups"
    backup_to_ftp: false

    # Execution mode
    dry_run: false

  tasks:
    # ========================================
    # Phase 1: Initialization
    # ========================================
    - name: Display execution mode
      ansible.builtin.include_tasks: tasks/01_display_execution_mode.yml

    - name: Test connectivity (pre-flight)
      ansible.builtin.include_tasks: tasks/test_connectivity.yml
      tags: ["connectivity_test"]

    - name: Initialize and detect model
      ansible.builtin.include_tasks: tasks/02_initialize_and_detect_model.yml

    # ========================================
    # Phase 2: Backup
    # ========================================
    - name: Backup configuration
      ansible.builtin.include_tasks: tasks/03_backup_configuration.yml

    # ========================================
    # Phase 3: Pre-Flight Checks
    # ========================================
    - name: Check boot mode
      ansible.builtin.include_tasks: tasks/04_check_boot_mode.yml

    - name: Prepare for upgrade
      ansible.builtin.include_tasks: tasks/05_prepare_for_upgrade.yml

    - name: Detailed flash space check
      ansible.builtin.include_tasks: tasks/check_flash_space_detailed.yml
      tags: ["detailed_flash_check"]

    # ========================================
    # Phase 4: Upgrade Execution
    # ========================================
    - name: Transfer image
      ansible.builtin.include_tasks: tasks/06_transfer_image.yml

    - name: Install and reboot
      ansible.builtin.include_tasks: tasks/07_install_and_reboot.yml

    # ========================================
    # Phase 5: Verification
    # ========================================
    - name: Post-upgrade verification
      ansible.builtin.include_tasks: tasks/08_post_verification.yml

---
- name: Backup Cisco Switch Configurations
  hosts: switches
  gather_facts: false
  vars:
    backup_dir_name: "backups"
    backup_to_ftp: false # Set to true to also backup to FTP server
    backup_enabled: true

  tasks:
    # Set backup directory
    - name: Set backup directory to project root
      ansible.builtin.set_fact:
        backup_dir: "{{ playbook_dir }}/../../{{ backup_dir_name }}"

    # Create timestamp
    - name: Create backup timestamp
      ansible.builtin.include_tasks: tasks/backup/create_backup_timestamp.yml

    # Gather facts
    - name: Gather switch facts
      ansible.builtin.include_tasks: tasks/common/gather_switch_facts.yml

    # Backup running config
    - name: Backup running config
      ansible.builtin.include_tasks: tasks/backup/backup_running_config.yml

    # Backup startup config
    - name: Backup startup config
      ansible.builtin.include_tasks: tasks/backup/backup_startup_config.yml

    # Save detailed summary
    - name: Save configuration summary
      ansible.builtin.include_tasks: tasks/backup/save_config_summary.yml

    # Optional FTP backup
    - name: FTP backup
      ansible.builtin.include_tasks: tasks/backup/ftp_backup.yml
      when: backup_to_ftp | bool

    # Display completion summary
    - name: Display backup summary
      ansible.builtin.include_tasks: tasks/backup/display_backup_summary.yml

- name: Backup summary report
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display backup summary
      ansible.builtin.debug:
        msg: |
          ==========================================
          Backup Session Complete
          ==========================================
          Total switches backed up: {{ groups['switches'] | length }}
          Backup directory: ./backups

          To restore a configuration:
          1. Review the backup files in ./backups/
          2. Copy to switch: copy ftp://... running-config
          3. Or use: configure replace ftp://...
          ==========================================
      when: groups['switches'] | length > 0
